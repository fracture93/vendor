local _, Addon = ...
local LIST_MGR_KEY = {}
local EMPTY = {}
local CustomListManager = {}
local savedLists = Addon.SavedVariable:new("CustomLists")

local function GetListId(source)
	if ((type(source) == "table") and (type(source.Id) == "string")) then
		return source.Id
	elseif (type(source) == "string") then
		return source
	end

	error("Unable to determine list ID: " .. type(source))
	return nil
end

function CustomListManager:CreateList(listName)
	local id = Addon:GetExtensionManger():CreateUniqueId()
	local list = 
	{
		Name = listName,
		Items = EMPTY,
	}

	savedLists:Set(id, list)
	list.Id = id
	return list
end

function CustomListManager:GetListContents(listId)
	local list = savedLists:Get(GetListId(listId))
	if (not list) then
		return EMPTY, false
	end
	return (list.Items or EMPTY), true
end

function CustomListManager:UpdateListContents(listId, items)
	Addon:Debug("test", "updaing list contents %s", listId)
	listId = GetListId(listId)	
	print("--> listId", listId)
	local list = savedLists:Get(listId)
	if (not list) then
		return false
	end

	list.Items = table.copy(items or EMPTY)
	savedLists:Set(listId, list)	
	Addon:Debug("test", "firing event %s", listId)
	self:TriggerEvent("OnListChanged", listId, "UPDATED")
end

function CustomListManager:GetLists()
	local results = {}
	savedLists:ForEach(function(list, id)
		table.insert(results, {
			Id = id,
			Name = list.Name,
			Description = list.Description
		})
	end)

	return results
end

function CustomListManager:GetList(search)
	local result = nil
	local resultId = nil
	savedLists:ForEach(function(list, id)
		if (not result) then
			if (id == search) then
				result = list
				resultId = id
			elseif (list.Name == search) then
				result = list
				resultId = id
			end
		end
	end)

	if (result) then
		return {
			Id = resultId,
			Name = result.Name,
			Description = result.Description,
			Items = table.copy(result.Items or EMPTY)
		}
	end

	return nil
end

local XX = {
[40431] = true,
[140836] = true,
[140900] = true,
[50699] = true,
[50715] = true,
[36934] = true,
[69237] = true,
[170539] = false,
[173542] = true,
[159298] = false,
[173670] = true,
[45877] = true,
[52025] = true,
[140839] = true,
[175651] = true,
[173671] = true,
[155850] = true,
[43993] = true,
[173480] = false,
[140840] = true,
[152146] = true,
[169073] = true,
[29989] = false,
[29997] = true,
[12208] = true,
[140841] = true,
[159301] = true,
[33454] = true,
[21877] = false,
[50349] = true,
[37606] = true,
[39666] = true,
[140842] = true,
[155853] = true,
[52026] = true,
[87636] = true,
[151063] = true,
[159303] = false,
[50605] = true,
[76075] = true,
[151958] = true,
[50653] = true,
[69560] = true,
[50701] = true,
[50733] = true,
[169844] = true,
[139248] = true,
[50366] = true,
[151960] = true,
[33024] = true,
[151066] = true,
[49919] = true,
[36154] = true,
[52027] = true,
[139250] = true,
[34701] = true,
[138867] = true,
[13446] = true,
[71446] = true,
[50638] = true,
[139251] = true,
[138868] = true,
[50702] = true,
[50718] = true,
[50734] = true,
[140849] = false,
[45704] = true,
[71447] = true,
[169849] = true,
[33025] = true,
[168955] = false,
[138870] = true,
[175656] = true,
[152284] = true,
[121270] = true,
[52028] = true,
[45525] = true,
[50619] = true,
[177634] = true,
[138871] = true,
[134336] = true,
[71416] = true,
[50607] = true,
[50623] = true,
[139191] = true,
[160136] = true,
[50671] = true,
[152158] = true,
[45864] = true,
[40211] = true,
[140835] = true,
[33470] = true,
[169852] = true,
[89174] = false,
[139320] = true,
[29998] = true,
[40195] = true,
[46376] = true,
[50352] = true,
[45258] = true,
[179562] = true,
[46312] = true,
[139321] = true,
[159314] = false,
[44332] = true,
[163019] = true,
[173814] = true,
[52029] = true,
[139194] = true,
[159187] = false,
[40212] = true,
[45702] = true,
[27875] = true,
[50606] = true,
[45285] = true,
[46025] = true,
[160146] = false,
[139259] = true,
[139197] = true,
[168747] = true,
[163278] = true,
[29991] = true,
[95245] = true,
[45642] = true,
[179565] = true,
[40564] = true,
[140857] = true,
[138366] = true,
[151974] = true,
[40628] = true,
[4338] = true,
[159573] = false,
[929] = true,
[152036] = true,
[34065] = true,
[69567] = true,
[163892] = true,
[45866] = true,
[40453] = true,
[52030] = true,
[169858] = true,
[139236] = true,
[140859] = false,
[36908] = true,
[117378] = true,
[30183] = true,
[157978] = false,
[50625] = true,
[50641] = true,
[139263] = true,
[50673] = true,
[139264] = true,
[50705] = true,
[159959] = false,
[45116] = true,
[45132] = true,
[168327] = false,
[124437] = true,
[29996] = true,
[152167] = true,
[45113] = true,
[50414] = true,
[34002] = true,
[45260] = true,
[152138] = true,
[139265] = true,
[140862] = true,
[140832] = true,
[159189] = true,
[111820] = false,
[141292] = true,
[139266] = true,
[5444] = true,
[50019] = true,
[140863] = true,
[45452] = true,
[50067] = true,
[13447] = true,
[45291] = true,
[182191] = true,
[139203] = true,
[40438] = true,
[138310] = true,
[50690] = true,
[50195] = true,
[29992] = true,
[50738] = true,
[139269] = true,
[151979] = true,
[40566] = true,
[139332] = true,
[28507] = true,
[40614] = true,
[45293] = true,
[71455] = true,
[124120] = true,
[49908] = false,
[140802] = true,
[138311] = true,
[174145] = true,
[46402] = true,
[46379] = false,
[50685] = true,
[43345] = true,
[138312] = true,
[50020] = true,
[45437] = true,
[140804] = true,
[45469] = true,
[138339] = true,
[50691] = true,
[50627] = true,
[151982] = true,
[40439] = true,
[139335] = true,
[152174] = true,
[50707] = true,
[50624] = true,
[161053] = true,
[140867] = true,
[50640] = true,
[138347] = true,
[139336] = true,
[160150] = true,
[36171] = true,
[121240] = true,
[152293] = true,
[139232] = true,
[36469] = true,
[87629] = true,
[168975] = true,
[45326] = true,
[23572] = true,
[49985] = true,
[173512] = false,
[70723] = true,
[151985] = true,
[41334] = false,
[57191] = true,
[36400] = true,
[45470] = true,
[175429] = true,
[152006] = true,
[34792] = true,
[139211] = true,
[3821] = false,
[50676] = true,
[3827] = true,
[50708] = true,
[29993] = true,
[9233] = true,
[87587] = true,
[35953] = true,
[140809] = true,
[40073] = true,
[33023] = true,
[45694] = true,
[159330] = false,
[39476] = true,
[124124] = false,
[50656] = true,
[45295] = true,
[138319] = true,
[50633] = true,
[46401] = true,
[45894] = true,
[138363] = true,
[169299] = false,
[139214] = true,
[6149] = true,
[57192] = true,
[159335] = false,
[152021] = true,
[43954] = true,
[45503] = true,
[140890] = true,
[45535] = true,
[152687] = true,
[140876] = true,
[159312] = true,
[46014] = true,
[50725] = true,
[140877] = true,
[45647] = true,
[139216] = true,
[45679] = true,
[36497] = true,
[33447] = true,
[45087] = true,
[40588] = true,
[28510] = true,
[45264] = true,
[173593] = true,
[36609] = true,
[50728] = true,
[71430] = true,
[50680] = true,
[158007] = true,
[49975] = true,
[45107] = true,
[50712] = true,
[45935] = true,
[140879] = true,
[28509] = true,
[5197] = true,
[45488] = true,
[50614] = true,
[173592] = true,
[45536] = true,
[27918] = true,
[160298] = true,
[46095] = true,
[45712] = true,
[29994] = true,
[152123] = true,
[161129] = false,
[33448] = true,
[140817] = true,
[140881] = true,
[30553] = true,
[3385] = true,
[155851] = true,
[58088] = false,
[45265] = true,
[71402] = true,
[139222] = true,
[173586] = true,
[14047] = false,
[45345] = true,
[50615] = true,
[8949] = true,
[159598] = false,
[87624] = true,
[46016] = true,
[173587] = true,
[36259] = true,
[50727] = true,
[176334] = true,
[142161] = true,
[45521] = true,
[50647] = true,
[32778] = true,
[140884] = true,
[173589] = true,
[155831] = true,
[176335] = true,
[45633] = true,
[168798] = true,
[139224] = true,
[33417] = true,
[40076] = true,
[1710] = true,
[3928] = true,
[50711] = true,
[45638] = true,
[3404] = true,
[151975] = true,
[33034] = true,
[50424] = true,
[858] = true,
[173937] = true,
[36371] = true,
[46067] = true,
[151937] = true,
[175441] = true,
[139801] = true,
[173591] = true,
[71783] = true,
[50073] = true,
[45490] = true,
[50616] = true,
[76097] = true,
[34807] = true,
[27919] = true,
[140888] = false,
[140880] = true,
[29987] = true,
[29995] = true,
[69167] = true,
[183621] = false,
[140815] = true,
[45682] = true,
[28502] = true,
[40093] = true,
[40109] = true,
[50706] = true,
[29259] = true,
[76098] = true,
[50416] = true,
[33035] = true,
[50425] = true,
[32769] = true,
[44000] = true,
[45874] = true,
[72234] = true,
[30236] = true,
[40511] = true,
[50651] = true,
[138336] = true,
[50180] = true,
[151239] = true,
[184518] = true,
[139212] = true,
[173404] = true,
[139231] = true,
[50665] = true,
[159799] = true,
[71777] = true,
[50713] = true,
[152043] = true,
[49212] = false,
[151943] = true,
[8766] = true,
[50684] = true,
[50412] = true,
[139334] = true,
[159571] = false,
[140860] = true,
[168743] = true,
[50426] = true,
[138359] = true,
[33036] = true,
[140894] = true,
[175706] = true,
[169851] = true,
[154883] = false,
[168744] = true,
[138375] = true,
[139333] = true,
[136743] = true,
[36430] = true,
[140800] = true,
[140852] = true,
[138372] = true,
[71470] = true,
[43991] = true,
[159164] = false,
[33292] = true,
[69554] = true,
[140791] = true,
[50732] = true,
[50730] = true,
[40526] = true,
[50737] = true,
[142302] = true,
[140797] = true,
[28503] = true,
[140904] = true,
[163149] = true,
[33026] = true,
[50363] = true,
[140853] = true,
[152012] = true,
[50639] = true,
[46339] = true,
[173666] = true,
[45893] = true,
[17056] = true,
[45892] = true,
[49996] = true,
[35625] = false,
[50028] = true,
[152141] = true,
[45972] = true,
[182744] = false,
[45493] = true,
[168749] = true,
[50635] = true,
[175465] = true,
}

function Addon:GetListManager()
	local mgr = rawget(self, LIST_MGR_KEY)
	if (not mgr) then
		local instance = {
		}
		
		mgr = Addon.object("CustomListManager", instance, CustomListManager, { "OnListChanged" })
		rawset(self, LIST_MGR_KEY, mgr)
	end

	return mgr
end